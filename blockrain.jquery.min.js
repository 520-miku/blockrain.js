/*!
 * BlockRain.js 0.1.0
 * jQuery plugin that lets you put a playable (and configurable) game of Tetris in your site or just leave it in auto in the background.
 * http://aerolab.github.io/blockrain.js/
 *
 * Copyright (c) 2015 Aerolab <hey@aerolab.co>
 *
 * Released under the MIT license
 * http://aerolab.github.io/blockrain.js/LICENSE.txt
 */
$.fn.safekeypress=function(t,e){function o(t){var o=e.stopKeys[t.keyCode]||e.moreStopKeys&&e.moreStopKeys[t.keyCode];return o&&t.preventDefault(),o}function r(t){return"safekeypress."+t.keyCode}function n(e){var n=r(e),i=($.data(this,n)||0)+1;return $.data(this,n,i),i>0?t.call(this,e):o(e)}function i(e){var o=r(e);return $.data(this,o,($.data(this,o)||0)-1),t.call(this,e)}function a(t){return $.data(this,r(t),0),o(t)}return e=$.extend({stopKeys:{37:1,38:1,39:1,40:1}},e),$(this).keypress(n).keydown(i).keyup(a)},$.fn.blockrain=function(t){return this.each(function(){function e(){x=h.innerWidth(),S=h.innerHeight(),B=Math.floor(x/b),C=Math.floor(B/10),x=B*b,S=B*w,M=2,u.attr("width",x).attr("height",S)}function o(t,e){return t+Math.floor(Math.random()*(1+e-t))}function r(t){return t[o(0,t.length-1)]}function n(t,e,o,r){r=r||g,t*=B,e*=B;var n=2,i=Math.round(.23*B);r.globalAlpha=1,r.fillStyle=o,r.fillRect(t,e,B,B),"string"==typeof l.theme.stroke&&(r.globalAlpha=1,r.fillStyle=l.theme.stroke,r.strokeStyle=l.theme.stroke,r.lineWidth=n,r.strokeRect(t,e,B,B),r.fillRect(t+i,e+i,B-2*i,n),r.fillRect(t+i,e+i+n,n,B-2*i-n)),r.globalAlpha=1}function i(t,e){return"boolean"!=typeof e&&(e=!0),e?"string"==typeof l.theme.primary&&""!==l.theme.primary?l.theme.primary:l.theme.blocks[t]:"string"==typeof l.theme.secondary&&""!==l.theme.secondary?l.theme.secondary:l.theme.blocks[t]}function a(t,e,o,r){return $.extend(this,{x:0,y:0,symmetrical:o,init:function(){return $.extend(this,{orientation:0,x:Math.floor(b/2)-1,y:-1}),this},blockType:r,color:e,blocksLen:t[0].length,orientations:t,orientation:0,rotate:function(t){var e=(this.orientation+(t?1:-1)+4)%4;s(this.x,this.y,this.getBlocks(e))||(this.orientation=e)},moveRight:function(){s(this.x+1,this.y,this.getBlocks())||this.x++},moveLeft:function(){s(this.x-1,this.y,this.getBlocks())||this.x--},getBlocks:function(t){return this.orientations[void 0!==t?t:this.orientation]},draw:function(t,e,o,r,i){t&&this.y++;for(var a=this.getBlocks(r),s=void 0===e?this.x:e,c=void 0===o?this.y:o,l=0;l<this.blocksLen;l+=2)n(s+a[l],c+a[l+1],this.color,i)},getBounds:function(t){for(var e=$.isArray(t)?t:this.getBlocks(t),o=0,r=e.length,n=999,i=-999,a=999,s=-999;r>o;o+=2)e[o]<n&&(n=e[o]),e[o]>i&&(i=e[o]),e[o+1]<a&&(a=e[o+1]),e[o+1]>s&&(s=e[o+1]);return{left:n,right:i,top:a,bottom:s,width:i-n,height:s-a}}}),this.init()}function s(t,e,o,r){for(var n,i,a=0,s=o.length;s>a;a+=2){if(n=t+o[a],i=e+o[a+1],i>=w||R.check(n,i))return!0;if(!r&&0>n||n>=b)return!0}return!1}function c(){return R.clearAll(),R._resetScore(),Z.started=!0,Z.animate(),p.fadeOut(150),v.hide(150),!1}var l={autoplay:!1,showFieldOnStart:!0,theme:$.fn.blockrain.themes.retro,blockWidth:10,autoBlockWidth:!1,autoBlockSize:24,difficulty:"normal",onStart:function(){},onRestart:function(){},onGameOver:function(){}};"object"!=typeof t&&(t={}),l=$.extend(l,t),"string"==typeof l.theme&&(l.theme=$.fn.blockrain.themes[l.theme]);var h=$(this),f=$('<div class="blockrain-game-holder"></div>');h.html("").append(f),f.css("position","relative").css("width","100%").css("height","100%"),l.autoBlockWidth&&(l.blockWidth=Math.ceil(h.width()/l.autoBlockSize));var u=$('<canvas style="width:100%; height:100%; display:block;" />');f.append(u);var d=$('<div class="blockrain-score-holder" style="position:absolute; top:0; right:0; "><div class="blockrain-score"><div class="blockrain-score-msg">Score</div><div class="blockrain-score-num">0</div></div></div>'),k=d.find(".blockrain-score-num");f.append(d);var p=$('<div class="blockrain-start-holder" style="position:absolute; top:0; left:0; right:0; bottom:0;"><div class="blockrain-start"><button class="blockrain-start-btn">Play blockrain</button></div></div>');f.append(p),p.find(".blockrain-start-btn").click(function(t){t.preventDefault(),c(),l.onStart()});var v=$('<div class="blockrain-game-over-holder" style="position:absolute; top:0; left:0; right:0; bottom:0; display:none;"><div class="blockrain-game-over"><div class="blockrain-game-over-msg">Game Over</div><button class="blockrain-game-over-btn">Play Again</button></div></div>');v.find(".blockrain-game-over-btn").click(function(t){t.preventDefault(),c(),l.onRestart()}),f.append(v);var m=function(t,e){function o(t,o,r,n,i,a,s){var c,l,h,f,u=o.length,d=0,k={};for(c=0;u>c;c+=2)d+=t[i.asIndex(r+o[c],n+o[c+1])]||0;for(c=0;u>c;c+=2)l=o[c],h=o[c+1],(k[l]===e||k[l]<h)&&(k[l]=h);f=0;for(l in k)for(l=parseInt(l),h=k[l]+1,c=0;s>n+h;h++,c++)if(!i.check(r+l,n+h)){f+=0==c?2:1;break}return d-=f}function r(){for(var t in i)i[t].x=0,i[t].y=-1}var n,i={};for(n in t)i[n]=t[n]();var a=function(t,n,a,s,c,l){l||r();var h,f,u,d,k,p,v,m,y,g,b,w,x,$,S,B=new Array(a*s),C="evil"==c,M=999*(C?1:-1);for(h=0;a>h;h++)for(f=0;s>=f;f++)if(f==s||t.check(h,f)){for(u=f-4;f>u;u++)B[t.asIndex(h,u)]=u;break}var H=l===e?i:{cur:l};for(d in H){for(k=H[d],x=-999,p=0;p<(k.symmetrical?2:4);p++)for(v=k.getBlocks(p),m=k.getBounds(v),h=-m.left;h<a-m.width;h++)for(f=-1;f<s-m.bottom;f++)if(n(h,f+1,v,!0)){y=o(B,v,h,f,t,a,s),y>x&&(x=y,$=p,S=h);break}(C&&M>x||!C&&x>M)&&(g=k,M=x,b=$,w=S)}return g.best_orientation=b,g.best_x=w,g};return a.no_preview=!0,a},y=u.get(0),g=y.getContext("2d"),b=l.blockWidth,w=Math.floor(h.innerHeight()/h.innerWidth()*b),x=h.innerWidth(),S=h.innerHeight(),B=Math.floor(x/b),C=Math.floor(B/5),M=2,H=!1;e(),$(window).resize(function(){e()});var _={line:function(){var t=[0,-1,0,-2,0,-3,0,-4],e=[-1,-2,0,-2,1,-2,2,-2];return new a([t,e,t,e],i("line"),!0,"line")},square:function(){var t=[0,0,1,0,0,-1,1,-1];return new a([t,t,t,t],i("square"),!0,"square")},arrow:function(){return new a([[0,-1,1,-1,2,-1,1,-2],[1,-2,1,-1,1,0,2,-1],[0,-1,1,-1,2,-1,1,0],[0,-1,1,-1,1,-2,1,0]],i("arrow"),!1,"arrow")},rightHook:function(){return new a([[0,0,0,-1,1,-1,2,-1],[0,-2,1,0,1,-1,1,-2],[0,-1,1,-1,2,-1,2,-2],[0,-2,0,-1,0,0,1,0]],i("rightHook"),!1,"rightHook")},leftHook:function(){return new a([[2,0,0,-1,1,-1,2,-1],[0,0,1,0,1,-1,1,-2],[0,-2,0,-1,1,-1,2,-1],[0,0,0,-1,0,-2,1,-2]],i("leftHook"),!1,"leftHook")},leftZag:function(){var t=[0,0,0,-1,1,-1,1,-2],e=[0,-1,1,-1,1,0,2,0];return new a([e,t,e,t],i("leftZag"),!0,"leftZag")},rightZag:function(){var t=[0,-2,0,-1,1,-1,1,0],e=[0,0,1,0,1,-1,2,-1];return new a([e,t,e,t],i("rightZag"),!0,"rightZag")}},D=[];$.each(_,function(t,e){D.push(e)});var R={data:new Array(b*w),score:0,toClear:{},check:function(t,e){return this.data[this.asIndex(t,e)]},add:function(t,e,o){t>=0&&b>t&&e>=0&&w>e&&(this.data[this.asIndex(t,e)]=o)},asIndex:function(t,e){return t+e*b},asX:function(t){return t%b},asY:function(t){return Math.floor(t/b)},clearAll:function(){this.data=new Array(b*w)},_popRow:function(t){for(var e=b*(t+1)-1;e>=0;e--)this.data[e]=e>=b?this.data[e-b]:void 0},checkForClears:function(){var t,e,o,r,n=Z.lines,i=[];for(t=0,e=this.data.length;e>t;t++)r=this.asX(t),0==r&&(o=0),this.data[t]&&"string"==typeof this.data[t]&&(o+=1),r==b-1&&o==b&&i.push(this.asY(t));for(t=0,e=i.length;e>t;t++)this._popRow(i[t]),Z.lines++,Z.lines%10==0&&Z.dropDelay>1&&(Z.dropDelay-=2);var a=Z.lines-n;this._updateScore(a)},_updateScore:function(t){if(!(0>=t)){var e=[0,400,1e3,3e3,12e3];t>=e.length&&(t=e.length-1),this.score+=e[t],k.text(this.score)}},_resetScore:function(){this.score=0,k.text(this.score)},draw:function(){for(var t,e,o=0,r=this.data.length;r>o;o++)void 0!==this.data[o]&&(t=this.asY(o),e=this.data[o],n(this.asX(o),t,e))}},A=m(_),Z={animateDelay:10,cur:null,lines:0,dropCount:0,dropDelay:24,init:function(){this.cur=this.nextShape();var t,e,a,s,c,h=[],f=[];for(var t in _)f.push(i(t,!1));for(t=0,e=b;e>t;t++)for(a=0,s=r([o(0,8),o(5,9)]);s>a;a++)c&&o(0,3)||(c=r(f)),h.push([t,w-a,c]);if(l.showFieldOnStart)for(t=0,e=h.length;e>t;t++)n.apply(n,h[t]);this.showStartMessage()},showStartMessage:function(){p.show()},showGameOverMessage:function(){v.show()},nextShape:function(t){var e,o,n,i=this.next;if(e=_[O.mode]?_[O.mode]:"nice"==O.mode||"evil"==O.mode?A:r(D),e.no_preview){if(this.next=null,t)return null;if(o=e(R,s,b,w,O.mode),!o)throw new Error("No shape returned from shape function!",e);o.init(),n=o}else{if(o=e(R,s,b,w,O.mode),!o)throw new Error("No shape returned from shape function!",e);if(o.init(),this.next=o,t)return null;n=i||this.nextShape()}return H&&(A(R,s,b,w,"normal",n),n.orientation=n.best_orientation,n.x=n.best_x),n},animate:function(){var t=!1,o=!1;if(e(),!this.paused){if(this.dropCount++,(this.dropCount>=this.dropDelay||H)&&(t=!0,this.dropCount=0),t){var r=this.cur,n=r.x,a=r.y,h=r.getBlocks();if(s(n,a+1,h,!0)){t=!1;for(var f=0;f<r.blocksLen;f+=2)R.add(n+h[f],a+h[f+1],i(r.blockType,!1)),a+h[f]<0&&(o=!0);R.checkForClears(),this.cur=this.nextShape()}}g.clearRect(0,0,x,S),R.draw(),this.cur.draw(t)}o?(l.onGameOver(R.score),H?c():(this.showGameOverMessage(),Z.gameOver=!0)):window.setTimeout(function(){Z.animate()},this.animateDelay)}},O={mode:l.difficulty,modes:["normal","nice","evil"],modesY:170,autopilotY:null,init:function(){this.mode=l.difficulty},setMode:function(t){this.mode=t,Z.nextShape(!0)}};O.init(),Z.init(),l.autoplay?(H=!0,c()):($(document).keyup(function(t){return Z.started||13!=t.keyCode&&32!=t.keyCode?!0:c(t)}),$(document).keyup(function(t){80==t.keyCode&&(Z.paused=!Z.paused)}),$(document).safekeypress(function(t){var e=!1;if(Z.cur)switch(e=!0,t.keyCode){case 37:Z.cur.moveLeft();break;case 38:Z.cur.rotate(!0);break;case 39:Z.cur.moveRight();break;case 40:Z.dropCount=Z.dropDelay;break;case 88:Z.cur.rotate(!0);break;case 90:Z.cur.rotate(!1);break;default:e=!1}return e&&t.preventDefault(),!e}))})},$.fn.blockrain.themes={modern:{primary:null,secondary:null,stroke:null,blocks:{line:"#fa1e1e",square:"#f1fa1e",arrow:"#d838cb",rightHook:"#f5821f",leftHook:"#42c6f0",rightZag:"#4bd838",leftZag:"#fa1e1e"}},retro:{primary:null,secondary:null,stroke:"#000000",blocks:{line:"#fa1e1e",square:"#f1fa1e",arrow:"#d838cb",rightHook:"#f5821f",leftHook:"#42c6f0",rightZag:"#4bd838",leftZag:"#fa1e1e"}},monochrome:{primary:"#ffffff",secondary:"#ffffff",stroke:"#000000"},aerolab:{primary:"#ff7b00",secondary:"#000000"},chocolate:{primary:"#7B3F00",secondary:"#7B3F00",stroke:"#291811"}};