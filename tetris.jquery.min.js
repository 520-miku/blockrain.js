/*!
 * Tetris.js 0.1.0
 * jQuery plugin that lets you put a playable (and configurable) tetris in your site or just leave it in auto in the background.
 * http://aerolab.github.io/tetris.js/
 *
 * Copyright (c) 2015 Aerolab <hey@aerolab.co>
 *
 * Released under the MIT license
 * http://aerolab.github.io/tetris.js/LICENSE.txt
 */
$.fn.safekeypress=function(t,e){function r(t){var r=e.stopKeys[t.keyCode]||e.moreStopKeys&&e.moreStopKeys[t.keyCode];return r&&t.preventDefault(),r}function o(t){return"safekeypress."+t.keyCode}function i(e){var i=o(e),n=($.data(this,i)||0)+1;return $.data(this,i,n),n>0?t.call(this,e):r(e)}function n(e){var r=o(e);return $.data(this,r,($.data(this,r)||0)-1),t.call(this,e)}function a(t){return $.data(this,o(t),0),r(t)}return e=$.extend({stopKeys:{37:1,38:1,39:1,40:1}},e),$(this).keypress(i).keydown(n).keyup(a)},$.fn.tetris=function(t){return $.fn.tetris.themes={modern:{primary:null,secondary:null,stroke:null,blocks:{line:"#fa1e1e",square:"#f1fa1e",arrow:"#d838cb",rightHook:"#f5821f",leftHook:"#42c6f0",rightZag:"#4bd838",leftZag:"#fa1e1e"}},retro:{primary:null,secondary:null,stroke:"#000000",blocks:{line:"#fa1e1e",square:"#f1fa1e",arrow:"#d838cb",rightHook:"#f5821f",leftHook:"#42c6f0",rightZag:"#4bd838",leftZag:"#fa1e1e"}},monochrome:{primary:"#ffffff",secondary:"#ffffff",stroke:"#000000"},aerolab:{primary:"#ff7b00",secondary:"#000000"}},this.each(function(){function e(){x=c.innerWidth(),S=c.innerHeight(),C=Math.floor(x/b),M=Math.floor(C/10),x=C*b,S=C*w,B=2,u.attr("width",x).attr("height",S)}function r(t,e){return t+Math.floor(Math.random()*(1+e-t))}function o(t){return t[r(0,t.length-1)]}function i(t,e,r,o){o=o||k,t*=C,e*=C;var i=2,n=Math.round(.23*C);o.globalAlpha=1,o.fillStyle=r,o.fillRect(t,e,C,C),"string"==typeof f.theme.stroke&&(o.globalAlpha=1,o.fillStyle=f.theme.stroke,o.strokeStyle=f.theme.stroke,o.lineWidth=i,o.strokeRect(t,e,C,C),o.fillRect(t+n,e+n,C-2*n,i),o.fillRect(t+n,e+n+i,i,C-2*n-i)),o.globalAlpha=1}function n(t,e){return"boolean"!=typeof e&&(e=!0),e?"string"==typeof f.theme.primary&&""!==f.theme.primary?f.theme.primary:f.theme.blocks[t]:"string"==typeof f.theme.secondary&&""!==f.theme.secondary?f.theme.secondary:f.theme.blocks[t]}function a(t,e,r,o){return $.extend(this,{x:0,y:0,symmetrical:r,init:function(){return $.extend(this,{orientation:0,x:Math.floor(b/2)-1,y:-1}),this},blockType:o,color:e,blocksLen:t[0].length,orientations:t,orientation:0,rotate:function(t){var e=(this.orientation+(t?1:-1)+4)%4;s(this.x,this.y,this.getBlocks(e))||(this.orientation=e)},moveRight:function(){s(this.x+1,this.y,this.getBlocks())||this.x++},moveLeft:function(){s(this.x-1,this.y,this.getBlocks())||this.x--},getBlocks:function(t){return this.orientations[void 0!==t?t:this.orientation]},draw:function(t,e,r,o,n){t&&this.y++;for(var a=this.getBlocks(o),s=void 0===e?this.x:e,h=void 0===r?this.y:r,f=0;f<this.blocksLen;f+=2)i(s+a[f],h+a[f+1],this.color,n)},getBounds:function(t){for(var e=$.isArray(t)?t:this.getBlocks(t),r=0,o=e.length,i=999,n=-999,a=999,s=-999;o>r;r+=2)e[r]<i&&(i=e[r]),e[r]>n&&(n=e[r]),e[r+1]<a&&(a=e[r+1]),e[r+1]>s&&(s=e[r+1]);return{left:i,right:n,top:a,bottom:s,width:n-i,height:s-a}}}),this.init()}function s(t,e,r,o){for(var i,n,a=0,s=r.length;s>a;a+=2){if(i=t+r[a],n=e+r[a+1],n>=w||D.check(i,n))return!0;if(!o&&0>i||i>=b)return!0}return!1}function h(){return D.clearAll(),D._resetScore(),A.started=!0,A.animate(),!1}var f={autoplay:!1,showFieldOnStart:!0,theme:$.fn.tetris.themes.retro,blockWidth:10,autoBlockWidth:!1,autoBlockSize:24,difficulty:"normal",onStart:function(){},onRestart:function(){},onGameOver:function(){}};"object"!=typeof t&&(t={}),f=$.extend(f,t),"string"==typeof f.theme&&(f.theme=$.fn.tetris.themes[f.theme]);var c=$(this),l=$('<div class="tetris-game-holder"></div>');c.html("").append(l),l.css("position","relative").css("width","100%").css("height","100%"),f.autoBlockWidth&&(f.blockWidth=Math.ceil(c.width()/f.autoBlockSize));var u=$('<canvas style="width:100%; height:100%; display:block;" />');l.append(u);var d=$('<div class="tetris-score-holder" style="position:absolute; top:0; right:0; "><div class="tetris-score"><div class="tetris-score-msg">Score</div><div class="tetris-score-num">0</div></div></div>'),p=d.find(".tetris-score-num");l.append(d);var v=$('<div class="tetris-start-holder" style="position:absolute; top:0; left:0; right:0; bottom:0;"><div class="tetris-start"><button class="tetris-start-btn btn">Play Tetris</button></div></div>');l.append(v),v.find(".tetris-start-btn").click(function(t){t.preventDefault(),v.fadeOut(200),m.fadeOut(200),h(),f.onStart()});var m=$('<div class="tetris-game-over-holder" style="position:absolute; top:0; left:0; right:0; bottom:0; display:none;"><div class="tetris-game-over"><div class="tetris-game-over-msg">Game Over</div><button class="tetris-game-over-btn btn">Play Again</button></div></div>');m.find(".tetris-game-over-btn").click(function(t){t.preventDefault(),v.fadeOut(200),m.fadeOut(200),h(),f.onRestart()}),l.append(m);var y=function(t,e){function r(t,r,o,i,n,a,s){var h,f,c,l,u=r.length,d=0,p={};for(h=0;u>h;h+=2)d+=t[n.asIndex(o+r[h],i+r[h+1])]||0;for(h=0;u>h;h+=2)f=r[h],c=r[h+1],(p[f]===e||p[f]<c)&&(p[f]=c);l=0;for(f in p)for(f=parseInt(f),c=p[f]+1,h=0;s>i+c;c++,h++)if(!n.check(o+f,i+c)){l+=0==h?2:1;break}return d-=l}function o(){for(var t in n)n[t].x=0,n[t].y=-1}var i,n={};for(i in t)n[i]=t[i]();var a=function(t,i,a,s,h,f){f||o();var c,l,u,d,p,v,m,y,g,k,b,w,x,$,S,C=new Array(a*s),M="evil"==h,B=999*(M?1:-1);for(c=0;a>c;c++)for(l=0;s>=l;l++)if(l==s||t.check(c,l)){for(u=l-4;l>u;u++)C[t.asIndex(c,u)]=u;break}var H=f===e?n:{cur:f};for(d in H){for(p=H[d],x=-999,v=0;v<(p.symmetrical?2:4);v++)for(m=p.getBlocks(v),y=p.getBounds(m),c=-y.left;c<a-y.width;c++)for(l=-1;l<s-y.bottom;l++)if(i(c,l+1,m,!0)){g=r(C,m,c,l,t,a,s),g>x&&(x=g,$=v,S=c);break}(M&&B>x||!M&&x>B)&&(k=p,B=x,b=$,w=S)}return k.best_orientation=b,k.best_x=w,k};return a.no_preview=!0,a},g=u.get(0),k=g.getContext("2d"),b=f.blockWidth,w=Math.floor(c.innerHeight()/c.innerWidth()*b),x=c.innerWidth(),S=c.innerHeight(),C=Math.floor(x/b),M=Math.floor(C/5),B=2,H=!1;e(),$(window).resize(function(){e()});var O={line:function(){var t=[0,-1,0,-2,0,-3,0,-4],e=[-1,-2,0,-2,1,-2,2,-2];return new a([t,e,t,e],n("line"),!0,"line")},square:function(){var t=[0,0,1,0,0,-1,1,-1];return new a([t,t,t,t],n("square"),!0,"square")},arrow:function(){return new a([[0,-1,1,-1,2,-1,1,-2],[1,-2,1,-1,1,0,2,-1],[0,-1,1,-1,2,-1,1,0],[0,-1,1,-1,1,-2,1,0]],n("arrow"),!1,"arrow")},rightHook:function(){return new a([[0,0,0,-1,1,-1,2,-1],[0,-2,1,0,1,-1,1,-2],[0,-1,1,-1,2,-1,2,-2],[0,-2,0,-1,0,0,1,0]],n("rightHook"),!1,"rightHook")},leftHook:function(){return new a([[2,0,0,-1,1,-1,2,-1],[0,0,1,0,1,-1,1,-2],[0,-2,0,-1,1,-1,2,-1],[0,0,0,-1,0,-2,1,-2]],n("leftHook"),!1,"leftHook")},leftZag:function(){var t=[0,0,0,-1,1,-1,1,-2],e=[0,-1,1,-1,1,0,2,0];return new a([e,t,e,t],n("leftZag"),!0,"leftZag")},rightZag:function(){var t=[0,-2,0,-1,1,-1,1,0],e=[0,0,1,0,1,-1,2,-1];return new a([e,t,e,t],n("rightZag"),!0,"rightZag")}},_=[];$.each(O,function(t,e){_.push(e)});var D={data:new Array(b*w),score:0,toClear:{},check:function(t,e){return this.data[this.asIndex(t,e)]},add:function(t,e,r){t>=0&&b>t&&e>=0&&w>e&&(this.data[this.asIndex(t,e)]=r)},asIndex:function(t,e){return t+e*b},asX:function(t){return t%b},asY:function(t){return Math.floor(t/b)},clearAll:function(){this.data=new Array(b*w)},_popRow:function(t){for(var e=b*(t+1)-1;e>=0;e--)this.data[e]=e>=b?this.data[e-b]:void 0},checkForClears:function(){var t,e,r,o,i=A.lines,n=[];for(t=0,e=this.data.length;e>t;t++)o=this.asX(t),0==o&&(r=0),this.data[t]&&"string"==typeof this.data[t]&&(r+=1),o==b-1&&r==b&&n.push(this.asY(t));for(t=0,e=n.length;e>t;t++)this._popRow(n[t]),A.lines++,A.lines%10==0&&A.dropDelay>1&&(A.dropDelay-=2);var a=A.lines-i;this._updateScore(a)},_updateScore:function(t){if(!(0>=t)){var e=[0,400,1e3,3e3,12e3];t>=e.length&&(t=e.length-1),this.score+=e[t],p.text(this.score)}},_resetScore:function(){this.score=0,p.text(this.score)},draw:function(){for(var t,e,r=0,o=this.data.length;o>r;r++)void 0!==this.data[r]&&(t=this.asY(r),e=this.data[r],i(this.asX(r),t,e))}},R=y(O),A={animateDelay:10,cur:null,lines:0,dropCount:0,dropDelay:24,init:function(){this.cur=this.nextShape();var t,e,a,s,h,c=[],l=[];for(var t in O)l.push(n(t,!1));for(t=0,e=b;e>t;t++)for(a=0,s=o([r(0,8),r(5,9)]);s>a;a++)h&&r(0,3)||(h=o(l)),c.push([t,w-a,h]);if(f.showFieldOnStart)for(t=0,e=c.length;e>t;t++)i.apply(i,c[t]);this.showStartMessage()},showStartMessage:function(){v.show()},showGameOverMessage:function(){m.show()},nextShape:function(t){var e,r,i,n=this.next;if(e=O[Z.mode]?O[Z.mode]:"nice"==Z.mode||"evil"==Z.mode?R:o(_),e.no_preview){if(this.next=null,t)return null;if(r=e(D,s,b,w,Z.mode),!r)throw new Error("No shape returned from shape function!",e);r.init(),i=r}else{if(r=e(D,s,b,w,Z.mode),!r)throw new Error("No shape returned from shape function!",e);if(r.init(),this.next=r,t)return null;i=n||this.nextShape()}return H&&(R(D,s,b,w,"normal",i),i.orientation=i.best_orientation,i.x=i.best_x),i},animate:function(){var t=!1,r=!1;if(e(),!this.paused){if(this.dropCount++,(this.dropCount>=this.dropDelay||H)&&(t=!0,this.dropCount=0),t){var o=this.cur,i=o.x,a=o.y,c=o.getBlocks();if(s(i,a+1,c,!0)){t=!1;for(var l=0;l<o.blocksLen;l+=2)D.add(i+c[l],a+c[l+1],n(o.blockType,!1)),a+c[l]<0&&(r=!0);D.checkForClears(),this.cur=this.nextShape()}}k.clearRect(0,0,x,S),D.draw(),this.cur.draw(t)}r?(f.onGameOver(D.score),H?h():(this.showGameOverMessage(),A.gameOver=!0)):window.setTimeout(function(){A.animate()},this.animateDelay)}},Z={mode:f.difficulty,modes:["normal","nice","evil"],modesY:170,autopilotY:null,init:function(){this.mode=f.difficulty},setMode:function(t){this.mode=t,A.nextShape(!0)}};Z.init(),A.init(),f.autoplay?(H=!0,v.hide(),m.hide(),h()):($(document).keyup(function(t){return A.started||13!=t.keyCode&&32!=t.keyCode?!0:h(t)}),$(document).keyup(function(t){80==t.keyCode&&(A.paused=!A.paused)}),$(document).safekeypress(function(t){var e=!1;if(A.cur)switch(e=!0,t.keyCode){case 37:A.cur.moveLeft();break;case 38:A.cur.rotate(!0);break;case 39:A.cur.moveRight();break;case 40:A.dropCount=A.dropDelay;break;case 88:A.cur.rotate(!0);break;case 90:A.cur.rotate(!1);break;default:e=!1}return e&&t.preventDefault(),!e}))})};