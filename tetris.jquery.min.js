/*!
 * Tetris.js 0.1.0
 * jQuery plugin that lets you put a playable (and configurable) tetris in your site or just leave it in auto in the background.
 * http://aerolab.github.io/tetris.js/
 *
 * Copyright (c) 2015 Aerolab <hey@aerolab.co>
 *
 * Released under the MIT license
 * http://aerolab.github.io/tetris.js/LICENSE.txt
 */
$.fn.safekeypress=function(t,e){function r(t){var r=e.stopKeys[t.keyCode]||e.moreStopKeys&&e.moreStopKeys[t.keyCode];return r&&t.preventDefault(),r}function o(t){return"safekeypress."+t.keyCode}function i(e){var i=o(e),n=($.data(this,i)||0)+1;return $.data(this,i,n),n>0?t.call(this,e):r(e)}function n(e){var r=o(e);return $.data(this,r,($.data(this,r)||0)-1),t.call(this,e)}function a(t){return $.data(this,o(t),0),r(t)}return e=$.extend({stopKeys:{37:1,38:1,39:1,40:1}},e),$(this).keypress(i).keydown(n).keyup(a)},$.fn.tetris=function(t){return $.fn.tetris.themes={modern:{primary:null,secondary:null,stroke:null,blocks:{line:"#fa1e1e",square:"#f1fa1e",arrow:"#d838cb",rightHook:"#f5821f",leftHook:"#42c6f0",rightZag:"#4bd838",leftZag:"#fa1e1e"}},retro:{primary:null,secondary:null,stroke:"#000000",blocks:{line:"#fa1e1e",square:"#f1fa1e",arrow:"#d838cb",rightHook:"#f5821f",leftHook:"#42c6f0",rightZag:"#4bd838",leftZag:"#fa1e1e"}},monochrome:{primary:"#ff7b00",secondary:"#000000"}},this.each(function(){function e(){w=f.innerWidth(),x=f.innerHeight(),S=Math.floor(w/k),C=Math.floor(S/10),w=S*k,x=S*b,M=2,c.attr("width",w).attr("height",x)}function r(t,e){return t+Math.floor(Math.random()*(1+e-t))}function o(t){return t[r(0,t.length-1)]}function i(t,e,r,o){o=o||g,t*=S,e*=S;var i=1,n=Math.round(.23*S);"string"==typeof l.theme.stroke&&(o.globalAlpha=1,o.fillStyle=l.theme.stroke,o.fillRect(t-i,e-i,S+2*i,S+2*i)),o.globalAlpha=1,o.fillStyle=r,"string"==typeof l.theme.stroke?o.fillRect(t+i,e+i,S-2*i,S-2*i):o.fillRect(t,e,S,S),"string"==typeof l.theme.stroke&&(o.globalAlpha=1,o.fillStyle=l.theme.stroke,o.fillRect(t+i*n,e+i*n,S-i*n*2,2*i),o.fillRect(t+i*n,e+i*n,2*i,S-i*n*2)),o.globalAlpha=1}function n(t,e){return"boolean"!=typeof e&&(e=!0),e?"string"==typeof l.theme.primary&&""!==l.theme.primary?l.theme.primary:l.theme.blocks[t]:"string"==typeof l.theme.secondary&&""!==l.theme.secondary?l.theme.secondary:l.theme.blocks[t]}function a(t,e,r,o){return $.extend(this,{x:0,y:0,symmetrical:r,init:function(){return $.extend(this,{orientation:0,x:Math.floor(k/2)-1,y:-1}),this},blockType:o,color:e,blocksLen:t[0].length,orientations:t,orientation:0,rotate:function(t){var e=(this.orientation+(t?1:-1)+4)%4;s(this.x,this.y,this.getBlocks(e))||(this.orientation=e)},moveRight:function(){s(this.x+1,this.y,this.getBlocks())||this.x++},moveLeft:function(){s(this.x-1,this.y,this.getBlocks())||this.x--},getBlocks:function(t){return this.orientations[void 0!==t?t:this.orientation]},draw:function(t,e,r,o,n){t&&this.y++;for(var a=this.getBlocks(o),s=void 0===e?this.x:e,h=void 0===r?this.y:r,l=0;l<this.blocksLen;l+=2)i(s+a[l],h+a[l+1],this.color,n)},getBounds:function(t){for(var e=$.isArray(t)?t:this.getBlocks(t),r=0,o=e.length,i=999,n=-999,a=999,s=-999;o>r;r+=2)e[r]<i&&(i=e[r]),e[r]>n&&(n=e[r]),e[r+1]<a&&(a=e[r+1]),e[r+1]>s&&(s=e[r+1]);return{left:i,right:n,top:a,bottom:s,width:n-i,height:s-a}}}),this.init()}function s(t,e,r,o){for(var i,n,a=0,s=r.length;s>a;a+=2){if(i=t+r[a],n=e+r[a+1],n>=b||D.check(i,n))return!0;if(!o&&0>i||i>=k)return!0}return!1}function h(){return D.clearAll(),R.started=!0,R.animate(),!1}var l={autoplay:!1,showFieldOnStart:!0,theme:$.fn.tetris.themes.retro,blockWidth:10,autoBlockWidth:!1,autoBlockSize:24,difficulty:"normal",onStart:function(){}};"object"!=typeof t&&(t={}),l=$.extend(l,t),"string"==typeof l.theme&&(l.theme=$.fn.tetris.themes[l.theme]);var f=$(this);f.html(""),l.autoBlockWidth&&(l.blockWidth=Math.ceil(f.width()/l.autoBlockSize));var c=$('<canvas style="width:100%; height:100%; display:block;" />');f.append(c);var u=$('<div class="tetris-score-holder" style="position:absolute; top:0; right:0; "><div class="tetris-score"><div class="tetris-score-msg">Score</div><div class="tetris-score-num">0</div></div></div>'),d=u.find(".tetris-score-num");f.append(u);var p=$('<div class="tetris-start-holder" style="position:absolute; top:0; left:0; right:0; bottom:0;"><div class="tetris-start"><button class="tetris-start-btn btn">Play Tetris</button></div></div>');f.append(p),p.find(".tetris-start-btn").click(function(t){t.preventDefault(),p.fadeOut(200),v.fadeOut(200),h(),l.onStart()});var v=$('<div class="tetris-game-over-holder" style="position:absolute; top:0; left:0; right:0; bottom:0; display:none;"><div class="tetris-game-over"><div class="tetris-game-over-msg">Game Over</div><button class="tetris-game-over-btn btn">Play Again</button></div></div>');v.find(".tetris-game-over-btn").click(function(t){t.preventDefault(),p.fadeOut(200),v.fadeOut(200),h(),l.onStart()}),f.append(v);var m=function(t,e){function r(t,r,o,i,n,a,s){var h,l,f,c,u=r.length,d=0,p={};for(h=0;u>h;h+=2)d+=t[n.asIndex(o+r[h],i+r[h+1])]||0;for(h=0;u>h;h+=2)l=r[h],f=r[h+1],(p[l]===e||p[l]<f)&&(p[l]=f);c=0;for(l in p)for(l=parseInt(l),f=p[l]+1,h=0;s>i+f;f++,h++)if(!n.check(o+l,i+f)){c+=0==h?2:1;break}return d-=c}function o(){for(var t in n)n[t].x=0,n[t].y=-1}var i,n={};for(i in t)n[i]=t[i]();var a=function(t,i,a,s,h,l){l||o();var f,c,u,d,p,v,m,y,g,k,b,w,x,$,S,C=new Array(a*s),M="evil"==h,B=999*(M?1:-1);for(f=0;a>f;f++)for(c=0;s>=c;c++)if(c==s||t.check(f,c)){for(u=c-4;c>u;u++)C[t.asIndex(f,u)]=u;break}var H=l===e?n:{cur:l};for(d in H){for(p=H[d],x=-999,v=0;v<(p.symmetrical?2:4);v++)for(m=p.getBlocks(v),y=p.getBounds(m),f=-y.left;f<a-y.width;f++)for(c=-1;c<s-y.bottom;c++)if(i(f,c+1,m,!0)){g=r(C,m,f,c,t,a,s),g>x&&(x=g,$=v,S=f);break}(M&&B>x||!M&&x>B)&&(k=p,B=x,b=$,w=S)}return k.best_orientation=b,k.best_x=w,k};return a.no_preview=!0,a},y=c.get(0),g=y.getContext("2d"),k=l.blockWidth,b=Math.floor(f.innerHeight()/f.innerWidth()*k),w=f.innerWidth(),x=f.innerHeight(),S=Math.floor(w/k),C=Math.floor(S/5),M=2,B=!1;e(),$(window).resize(function(){e()});var H={line:function(){var t=[0,-1,0,-2,0,-3,0,-4],e=[-1,-2,0,-2,1,-2,2,-2];return new a([t,e,t,e],n("line"),!0,"line")},square:function(){var t=[0,0,1,0,0,-1,1,-1];return new a([t,t,t,t],n("square"),!0,"square")},arrow:function(){return new a([[0,-1,1,-1,2,-1,1,-2],[1,-2,1,-1,1,0,2,-1],[0,-1,1,-1,2,-1,1,0],[0,-1,1,-1,1,-2,1,0]],n("arrow"),!1,"arrow")},rightHook:function(){return new a([[0,0,0,-1,1,-1,2,-1],[0,-2,1,0,1,-1,1,-2],[0,-1,1,-1,2,-1,2,-2],[0,-2,0,-1,0,0,1,0]],n("rightHook"),!1,"rightHook")},leftHook:function(){return new a([[2,0,0,-1,1,-1,2,-1],[0,0,1,0,1,-1,1,-2],[0,-2,0,-1,1,-1,2,-1],[0,0,0,-1,0,-2,1,-2]],n("leftHook"),!1,"leftHook")},leftZag:function(){var t=[0,0,0,-1,1,-1,1,-2],e=[0,-1,1,-1,1,0,2,0];return new a([e,t,e,t],n("leftZag"),!0,"leftZag")},rightZag:function(){var t=[0,-2,0,-1,1,-1,1,0],e=[0,0,1,0,1,-1,2,-1];return new a([e,t,e,t],n("rightZag"),!0,"rightZag")}},A=[];$.each(H,function(t,e){A.push(e)});var D={data:new Array(k*b),score:0,toClear:{},check:function(t,e){return this.data[this.asIndex(t,e)]},add:function(t,e,r){t>=0&&k>t&&e>=0&&b>e&&(this.data[this.asIndex(t,e)]=r)},asIndex:function(t,e){return t+e*k},asX:function(t){return t%k},asY:function(t){return Math.floor(t/k)},clearAll:function(){this.data=new Array(k*b)},_popRow:function(t){for(var e=k*(t+1)-1;e>=0;e--)this.data[e]=e>=k?this.data[e-k]:void 0},checkForClears:function(){var t,e,r,o,i=R.lines,n=[];for(t=0,e=this.data.length;e>t;t++)o=this.asX(t),0==o&&(r=0),this.data[t]&&"string"==typeof this.data[t]&&(r+=1),o==k-1&&r==k&&n.push(this.asY(t));for(t=0,e=n.length;e>t;t++)this._popRow(n[t]),R.lines++,R.lines%10==0&&R.dropDelay>1&&(R.dropDelay-=2);var a=R.lines-i;this._updateScore(a)},_updateScore:function(t){if(!(0>=t)){var e=[0,400,1e3,3e3,12e3];t>=e.length&&(t=e.length-1),this.score+=e[t],d.text(this.score)}},draw:function(){for(var t,e,r=0,o=this.data.length;o>r;r++)void 0!==this.data[r]&&(t=this.asY(r),e=this.data[r],i(this.asX(r),t,e))}},O=m(H),R={animateDelay:10,cur:null,lines:0,dropCount:0,dropDelay:24,init:function(){this.cur=this.nextShape();var t,e,a,s,h,f=[],c=[];for(var t in H)c.push(n(t,!1));for(t=0,e=k;e>t;t++)for(a=0,s=o([r(0,8),r(5,9)]);s>a;a++)h&&r(0,3)||(h=o(c)),f.push([t,b-a,h]);if(l.showFieldOnStart)for(t=0,e=f.length;e>t;t++)i.apply(i,f[t]);this.showStartMessage()},showStartMessage:function(){p.show()},showGameOverMessage:function(){v.show()},nextShape:function(t){var e,r,i,n=this.next;if(e=H[Z.mode]?H[Z.mode]:"nice"==Z.mode||"evil"==Z.mode?O:o(A),e.no_preview){if(this.next=null,t)return null;if(r=e(D,s,k,b,Z.mode),!r)throw new Error("No shape returned from shape function!",e);r.init(),i=r}else{if(r=e(D,s,k,b,Z.mode),!r)throw new Error("No shape returned from shape function!",e);if(r.init(),this.next=r,t)return null;i=n||this.nextShape()}return B&&(O(D,s,k,b,"normal",i),i.orientation=i.best_orientation,i.x=i.best_x),i},animate:function(){var t=!1,r=!1;if(e(),!this.paused){if(this.dropCount++,(this.dropCount>=this.dropDelay||B)&&(t=!0,this.dropCount=0),t){var o=this.cur,i=o.x,a=o.y,l=o.getBlocks();if(s(i,a+1,l,!0)){t=!1;for(var f=0;f<o.blocksLen;f+=2)D.add(i+l[f],a+l[f+1],n(o.blockType,!1)),a+l[f]<0&&(r=!0);D.checkForClears(),this.cur=this.nextShape()}}g.clearRect(0,0,w,x),D.draw(),this.cur.draw(t)}r?B?h():(this.showGameOverMessage(),R.gameOver=!0):window.setTimeout(function(){R.animate()},this.animateDelay)}},Z={mode:l.difficulty,modes:["normal","nice","evil"],modesY:170,autopilotY:null,init:function(){this.mode=l.difficulty},setMode:function(t){this.mode=t,R.nextShape(!0)}};Z.init(),R.init(),l.autoplay?(B=!0,p.hide(),v.hide(),h()):($(document).keyup(function(t){return R.started||13!=t.keyCode&&32!=t.keyCode?!0:h(t)}),$(document).keyup(function(t){80==t.keyCode&&(R.paused=!R.paused)}),$(document).safekeypress(function(t){var e=!1;if(R.cur)switch(e=!0,t.keyCode){case 37:R.cur.moveLeft();break;case 38:R.cur.rotate(!0);break;case 39:R.cur.moveRight();break;case 40:R.dropCount=R.dropDelay;break;case 88:R.cur.rotate(!0);break;case 90:R.cur.rotate(!1);break;default:e=!1}return e&&t.preventDefault(),!e}))})};