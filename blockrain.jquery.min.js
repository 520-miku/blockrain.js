/*!
 * BlockRain.js 0.1.0
 * jQuery plugin that lets you put a playable (and configurable) game of Tetris in your site or just leave it in auto in the background.
 * http://aerolab.github.io/blockrain.js/
 *
 * Copyright (c) 2015 Aerolab <hey@aerolab.co>
 *
 * Released under the MIT license
 * http://aerolab.github.io/blockrain.js/LICENSE.txt
 */
$.fn.safekeypress=function(t,e){function r(t){var r=e.stopKeys[t.keyCode]||e.moreStopKeys&&e.moreStopKeys[t.keyCode];return r&&t.preventDefault(),r}function o(t){return"safekeypress."+t.keyCode}function n(e){var n=o(e),i=($.data(this,n)||0)+1;return $.data(this,n,i),i>0?t.call(this,e):r(e)}function i(e){var r=o(e);return $.data(this,r,($.data(this,r)||0)-1),t.call(this,e)}function a(t){return $.data(this,o(t),0),r(t)}return e=$.extend({stopKeys:{37:1,38:1,39:1,40:1}},e),$(this).keypress(n).keydown(i).keyup(a)},$.fn.blockrain=function(t){return this.each(function(){function e(){x=f.innerWidth(),C=f.innerHeight(),B=Math.floor(x/w),x=B*w,C=B*S,A=2,d.attr("width",x).attr("height",C)}function r(t,e){return t+Math.floor(Math.random()*(1+e-t))}function o(t){return t[r(0,t.length-1)]}function n(t){if(t=t||b,"string"==typeof c.theme.background&&"string"==typeof c.theme.backgroundGrid){{var e=c.theme.strokeWidth;Math.round(.23*B),Math.round(.3*B)}t.globalAlpha=1,t.fillStyle=c.theme.backgroundGrid;for(var r=0;w>r;r++)for(var o=0;S>o;o++){var n=r*B,i=o*B;t.fillRect(n+e,i+e,B-2*e,B-2*e)}t.globalAlpha=1}}function i(t,e,r,o){o=o||b,t*=B,e*=B;var n=c.theme.strokeWidth,i=Math.round(.23*B),a=Math.round(.3*B);o.globalAlpha=1,o.fillStyle=r,o.fillRect(t,e,B,B),"string"==typeof c.theme.innerShadow&&(o.globalAlpha=1,o.strokeStyle=c.theme.innerShadow,o.lineWidth=1,o.strokeRect(t+1,e+1,B-2,B-2)),"string"==typeof c.theme.stroke&&(o.globalAlpha=1,o.fillStyle=c.theme.stroke,o.strokeStyle=c.theme.stroke,o.lineWidth=n,o.strokeRect(t,e,B,B)),"string"==typeof c.theme.innerStroke&&(o.fillStyle=c.theme.innerStroke,o.fillRect(t+i,e+i,B-2*i,n),o.fillRect(t+i,e+i+n,n,B-2*i-n)),"string"==typeof c.theme.innerSquare&&(o.fillStyle=c.theme.innerSquare,o.globalAlpha=.2,o.fillRect(t+a,e+a,B-2*a,B-2*a)),o.globalAlpha=1}function a(t,e){return"boolean"!=typeof e&&(e=!0),e?"string"==typeof c.theme.primary&&""!==c.theme.primary?c.theme.primary:c.theme.blocks[t]:"string"==typeof c.theme.secondary&&""!==c.theme.secondary?c.theme.secondary:c.theme.blocks[t]}function s(t,e,r,o){return $.extend(this,{x:0,y:0,symmetrical:r,init:function(){return $.extend(this,{orientation:0,x:Math.floor(w/2)-1,y:-1}),this},blockType:o,color:e,blocksLen:t[0].length,orientations:t,orientation:0,rotate:function(t){var e=(this.orientation+(t?1:-1)+4)%4;l(this.x,this.y,this.getBlocks(e))||(this.orientation=e)},moveRight:function(){l(this.x+1,this.y,this.getBlocks())||this.x++},moveLeft:function(){l(this.x-1,this.y,this.getBlocks())||this.x--},getBlocks:function(t){return this.orientations[void 0!==t?t:this.orientation]},draw:function(t,e,r,o,n){t&&this.y++;for(var a=this.getBlocks(o),s=void 0===e?this.x:e,l=void 0===r?this.y:r,h=0;h<this.blocksLen;h+=2)i(s+a[h],l+a[h+1],this.color,n)},getBounds:function(t){for(var e=$.isArray(t)?t:this.getBlocks(t),r=0,o=e.length,n=999,i=-999,a=999,s=-999;o>r;r+=2)e[r]<n&&(n=e[r]),e[r]>i&&(i=e[r]),e[r+1]<a&&(a=e[r+1]),e[r+1]>s&&(s=e[r+1]);return{left:n,right:i,top:a,bottom:s,width:i-n,height:s-a}}}),this.init()}function l(t,e,r,o){for(var n,i,a=0,s=r.length;s>a;a+=2){if(n=t+r[a],i=e+r[a+1],i>=S||W.check(n,i))return!0;if(!o&&0>n||n>=w)return!0}return!1}function h(){return W.clearAll(),W._resetScore(),R.started=!0,R.animate(),m.fadeOut(150),g.fadeOut(150),!1}var c={autoplay:!1,showFieldOnStart:!0,theme:null,blockWidth:10,autoBlockWidth:!1,autoBlockSize:24,difficulty:"normal",onStart:function(){},onRestart:function(){},onGameOver:function(){}};"object"!=typeof t&&(t={}),c=$.extend(c,t),"string"==typeof c.theme&&(c.theme=$.fn.blockrain.themes[c.theme]),("undefined"==typeof c.theme||null===c.theme)&&(c.theme=$.fn.blockrain.themes.retro),(isNaN(parseInt(c.theme.strokeWidth))||"number"!=typeof parseInt(c.theme.strokeWidth))&&(c.theme.strokeWidth=2);var f=$(this),u=$('<div class="blockrain-game-holder"></div>');f.html("").append(u),u.css("position","relative").css("width","100%").css("height","100%"),c.autoBlockWidth&&(c.blockWidth=Math.ceil(f.width()/c.autoBlockSize));var d=$('<canvas style="width:100%; height:100%; display:block;" />');"string"==typeof c.theme.background&&d.css("background-color",c.theme.background),u.append(d);var k=$('<div class="blockrain-score-holder" style="position:absolute; top:0; right:0; "><div class="blockrain-score"><div class="blockrain-score-msg">Score</div><div class="blockrain-score-num">0</div></div></div>'),p=k.find(".blockrain-score-num");u.append(k);var m=$('<div class="blockrain-start-holder" style="position:absolute; top:0; left:0; right:0; bottom:0;"><div class="blockrain-start"><button class="blockrain-start-btn">Play blockrain</button></div></div>');u.append(m),m.find(".blockrain-start-btn").click(function(t){t.preventDefault(),h(),c.onStart()});var g=$('<div class="blockrain-game-over-holder" style="position:absolute; top:0; left:0; right:0; bottom:0; display:none;"><div class="blockrain-game-over"><div class="blockrain-game-over-msg">Game Over</div><button class="blockrain-game-over-btn">Play Again</button></div></div>');g.find(".blockrain-game-over-btn").click(function(t){t.preventDefault(),h(),c.onRestart()}),u.append(g);var y=function(t,e){function r(t,r,o,n,i,a,s){var l,h,c,f,u=r.length,d=0,k={};for(l=0;u>l;l+=2)d+=t[i.asIndex(o+r[l],n+r[l+1])]||0;for(l=0;u>l;l+=2)h=r[l],c=r[l+1],(k[h]===e||k[h]<c)&&(k[h]=c);f=0;for(h in k)for(h=parseInt(h),c=k[h]+1,l=0;s>n+c;c++,l++)if(!i.check(o+h,n+c)){f+=0==l?2:1;break}return d-=f}function o(){for(var t in i)i[t].x=0,i[t].y=-1}var n,i={};for(n in t)i[n]=t[n]();var a=function(t,n,a,s,l,h){h||o();var c,f,u,d,k,p,m,g,y,v,b,w,S,x,$,C=new Array(a*s),B="evil"==l,A=999*(B?1:-1);for(c=0;a>c;c++)for(f=0;s>=f;f++)if(f==s||t.check(c,f)){for(u=f-4;f>u;u++)C[t.asIndex(c,u)]=u;break}var F=h===e?i:{cur:h};for(d in F){for(k=F[d],S=-999,p=0;p<(k.symmetrical?2:4);p++)for(m=k.getBlocks(p),g=k.getBounds(m),c=-g.left;c<a-g.width;c++)for(f=-1;f<s-g.bottom;f++)if(n(c,f+1,m,!0)){y=r(C,m,c,f,t,a,s),y>S&&(S=y,x=p,$=c);break}(B&&A>S||!B&&S>A)&&(v=k,A=S,b=x,w=$)}return v.best_orientation=b,v.best_x=w,v};return a.no_preview=!0,a},v=d.get(0),b=v.getContext("2d"),w=c.blockWidth,S=Math.floor(f.innerHeight()/f.innerWidth()*w),x=f.innerWidth(),C=f.innerHeight(),B=Math.floor(x/w),A=2,F=!1;e(),$(window).resize(function(){e()});var H={line:function(){var t=[0,-1,0,-2,0,-3,0,-4],e=[-1,-2,0,-2,1,-2,2,-2];return new s([t,e,t,e],a("line"),!0,"line")},square:function(){var t=[0,0,1,0,0,-1,1,-1];return new s([t,t,t,t],a("square"),!0,"square")},arrow:function(){return new s([[0,-1,1,-1,2,-1,1,-2],[1,-2,1,-1,1,0,2,-1],[0,-1,1,-1,2,-1,1,0],[0,-1,1,-1,1,-2,1,0]],a("arrow"),!1,"arrow")},rightHook:function(){return new s([[0,0,0,-1,1,-1,2,-1],[0,-2,1,0,1,-1,1,-2],[0,-1,1,-1,2,-1,2,-2],[0,-2,0,-1,0,0,1,0]],a("rightHook"),!1,"rightHook")},leftHook:function(){return new s([[2,0,0,-1,1,-1,2,-1],[0,0,1,0,1,-1,1,-2],[0,-2,0,-1,1,-1,2,-1],[0,0,0,-1,0,-2,1,-2]],a("leftHook"),!1,"leftHook")},leftZag:function(){var t=[0,0,0,-1,1,-1,1,-2],e=[0,-1,1,-1,1,0,2,0];return new s([e,t,e,t],a("leftZag"),!0,"leftZag")},rightZag:function(){var t=[0,-2,0,-1,1,-1,1,0],e=[0,0,1,0,1,-1,2,-1];return new s([e,t,e,t],a("rightZag"),!0,"rightZag")}},M=[];$.each(H,function(t,e){M.push(e)});var W={data:new Array(w*S),score:0,toClear:{},check:function(t,e){return this.data[this.asIndex(t,e)]},add:function(t,e,r){t>=0&&w>t&&e>=0&&S>e&&(this.data[this.asIndex(t,e)]=r)},asIndex:function(t,e){return t+e*w},asX:function(t){return t%w},asY:function(t){return Math.floor(t/w)},clearAll:function(){this.data=new Array(w*S)},_popRow:function(t){for(var e=w*(t+1)-1;e>=0;e--)this.data[e]=e>=w?this.data[e-w]:void 0},checkForClears:function(){var t,e,r,o,n=R.lines,i=[];for(t=0,e=this.data.length;e>t;t++)o=this.asX(t),0==o&&(r=0),this.data[t]&&"string"==typeof this.data[t]&&(r+=1),o==w-1&&r==w&&i.push(this.asY(t));for(t=0,e=i.length;e>t;t++)this._popRow(i[t]),R.lines++,R.lines%10==0&&R.dropDelay>1&&(R.dropDelay-=2);var a=R.lines-n;this._updateScore(a)},_updateScore:function(t){if(!(0>=t)){var e=[0,400,1e3,3e3,12e3];t>=e.length&&(t=e.length-1),this.score+=e[t],p.text(this.score)}},_resetScore:function(){this.score=0,p.text(this.score)},draw:function(){for(var t,e,r=0,o=this.data.length;o>r;r++)void 0!==this.data[r]&&(t=this.asY(r),e=this.data[r],i(this.asX(r),t,e))}},D=y(H),R={animateDelay:1e3/c.speed,cur:null,lines:0,dropCount:0,dropDelay:5,init:function(){this.cur=this.nextShape();var t,e,n,s,l,h=[],f=[];for(var t in H)f.push(a(t,!1));for(t=0,e=w;e>t;t++)for(n=0,s=o([r(0,8),r(5,9)]);s>n;n++)l&&r(0,3)||(l=o(f)),h.push([t,S-n,l]);if(c.showFieldOnStart)for(t=0,e=h.length;e>t;t++)i.apply(i,h[t]);this.showStartMessage()},showStartMessage:function(){m.show()},showGameOverMessage:function(){g.show()},nextShape:function(t){var e,r,n,i=this.next;if(e=H[Z.mode]?H[Z.mode]:"nice"==Z.mode||"evil"==Z.mode?D:o(M),e.no_preview){if(this.next=null,t)return null;if(r=e(W,l,w,S,Z.mode),!r)throw new Error("No shape returned from shape function!",e);r.init(),n=r}else{if(r=e(W,l,w,S,Z.mode),!r)throw new Error("No shape returned from shape function!",e);if(r.init(),this.next=r,t)return null;n=i||this.nextShape()}return F&&(D(W,l,w,S,"normal",n),n.orientation=n.best_orientation,n.x=n.best_x),n},animate:function(){var t=!1,r=!1;if(e(),!this.paused){if(this.dropCount++,(this.dropCount>=this.dropDelay||F)&&(t=!0,this.dropCount=0),t){var o=this.cur,i=o.x,s=o.y,f=o.getBlocks();if(l(i,s+1,f,!0)){t=!1;for(var u=0;u<o.blocksLen;u+=2)W.add(i+f[u],s+f[u+1],a(o.blockType,!1)),s+f[u]<0&&(r=!0);W.checkForClears(),this.cur=this.nextShape()}}b.clearRect(0,0,x,C),n(),W.draw(),this.cur.draw(t)}r?(c.onGameOver(W.score),F?h():(this.showGameOverMessage(),R.gameOver=!0)):window.setTimeout(function(){R.animate()},this.animateDelay)}},Z={mode:c.difficulty,modes:["normal","nice","evil"],modesY:170,autopilotY:null,init:function(){this.mode=c.difficulty},setMode:function(t){this.mode=t,R.nextShape(!0)}};Z.init(),R.init(),c.autoplay?(F=!0,h()):($(document).keyup(function(t){return R.started||13!=t.keyCode&&32!=t.keyCode?!0:h(t)}),$(document).keyup(function(t){80==t.keyCode&&(R.paused=!R.paused)}),$(document).safekeypress(function(t){var e=!1;if(R.cur)switch(e=!0,t.keyCode){case 37:R.cur.moveLeft();break;case 38:R.cur.rotate(!0);break;case 39:R.cur.moveRight();break;case 40:R.dropCount=R.dropDelay;break;case 88:R.cur.rotate(!0);break;case 90:R.cur.rotate(!1);break;default:e=!1}return e&&t.preventDefault(),!e}))})},$.fn.blockrain.themes={candy:{background:"#040304",backgroundGrid:"#211F22",primary:null,secondary:null,stroke:null,innerStroke:null,innerSquare:"#000000",innerShadow:"#000000",blocks:{line:"#5BCBF3",square:"#F2AC3B",arrow:"#BA009D",rightHook:"#ED8D33",leftHook:"#4350D6",rightZag:"#C33150",leftZag:"#6BCE2F"}},modern:{primary:null,secondary:null,stroke:null,blocks:{line:"#fa1e1e",square:"#f1fa1e",arrow:"#d838cb",rightHook:"#f5821f",leftHook:"#42c6f0",rightZag:"#4bd838",leftZag:"#fa1e1e"}},retro:{primary:null,secondary:null,stroke:"#000000",innerStroke:"#000000",blocks:{line:"#fa1e1e",square:"#f1fa1e",arrow:"#d838cb",rightHook:"#f5821f",leftHook:"#42c6f0",rightZag:"#4bd838",leftZag:"#fa1e1e"}},monochrome:{primary:"#ffffff",secondary:"#ffffff",stroke:"#000000",innerStroke:"#000000"},aerolab:{primary:"#ff7b00",secondary:"#000000"},chocolate:{primary:"#7B3F00",secondary:"#7B3F00",stroke:"#291811",innerStroke:"#291811"},gameboy:{background:"#C4CFA1",primary:null,secondary:null,stroke:"#414141",innerStroke:"#414141",blocks:{line:"#88926A",square:"#585E44",arrow:"#A4AC8C",rightHook:"#6B7353",leftHook:"#6B7353",rightZag:"#595F45",leftZag:"#595F45"}},vim:{background:"#000000",primary:"#C2FFAE",secondary:"#C2FFAE",stroke:"#000000",strokeWidth:3,innerStroke:null}};