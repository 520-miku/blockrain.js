/*!
 * Tetris.js 0.1.0
 * jQuery plugin that lets you put a playable (and configurable) tetris in your site or just leave it in auto in the background.
 * http://aerolab.github.io/tetris.js/
 *
 * Copyright (c) 2015 Aerolab <hey@aerolab.co>
 *
 * Released under the MIT license
 * http://aerolab.github.io/tetris.js/LICENSE.txt
 */
$.fn.safekeypress=function(t,e){function r(t){var r=e.stopKeys[t.keyCode]||e.moreStopKeys&&e.moreStopKeys[t.keyCode];return r&&t.preventDefault(),r}function n(t){return"safekeypress."+t.keyCode}function i(e){var i=n(e),o=($.data(this,i)||0)+1;return $.data(this,i,o),o>0?t.call(this,e):r(e)}function o(e){var r=n(e);return $.data(this,r,($.data(this,r)||0)-1),t.call(this,e)}function a(t){return $.data(this,n(t),0),r(t)}return e=$.extend({stopKeys:{37:1,38:1,39:1,40:1}},e),$(this).keypress(i).keydown(o).keyup(a)},$.fn.tetris=function(t){return $.fn.tetris.themes={retro:{primary:null,secondary:null,blocks:{line:"#fa1e1e",square:"#f1fa1e",arrow:"#d838cb",rightHook:"#f5821f",leftHook:"#42c6f0",rightZag:"#4bd838",leftZag:"#fa1e1e"}},monochrome:{primary:"#ff7b00",secondary:"#000000"}},this.each(function(){function e(){w=u.innerWidth(),x=u.innerHeight(),S=Math.floor(w/k),C=Math.floor(S/10),w=S*k,x=S*b,M=2,f.attr("width",w).attr("height",x)}function r(t,e){return t+Math.floor(Math.random()*(1+e-t))}function n(t){return t[r(0,t.length-1)]}function i(t,e,r,n){n=n||g,t*=S,e*=S,n.fillStyle=r,n.globalAlpha=1,n.fillRect(t,e,S,S),n.globalAlpha=1}function o(t,e){return"boolean"!=typeof e&&(e=!0),e?"string"==typeof c.theme.primary&&""!==c.theme.primary?c.theme.primary:c.theme.blocks[t]:"string"==typeof c.theme.secondary&&""!==c.theme.secondary?c.theme.secondary:c.theme.blocks[t]}function a(t,e,r,n){return $.extend(this,{x:0,y:0,symmetrical:r,init:function(){return $.extend(this,{orientation:0,x:Math.floor(k/2)-1,y:-1}),this},blockType:n,color:e,blocksLen:t[0].length,orientations:t,orientation:0,rotate:function(t){var e=(this.orientation+(t?1:-1)+4)%4;s(this.x,this.y,this.getBlocks(e))||(this.orientation=e)},moveRight:function(){s(this.x+1,this.y,this.getBlocks())||this.x++},moveLeft:function(){s(this.x-1,this.y,this.getBlocks())||this.x--},getBlocks:function(t){return this.orientations[void 0!==t?t:this.orientation]},draw:function(t,e,r,n,o){t&&this.y++;for(var a=this.getBlocks(n),s=void 0===e?this.x:e,h=void 0===r?this.y:r,c=0;c<this.blocksLen;c+=2)i(s+a[c],h+a[c+1],this.color,o)},getBounds:function(t){for(var e=$.isArray(t)?t:this.getBlocks(t),r=0,n=e.length,i=999,o=-999,a=999,s=-999;n>r;r+=2)e[r]<i&&(i=e[r]),e[r]>o&&(o=e[r]),e[r+1]<a&&(a=e[r+1]),e[r+1]>s&&(s=e[r+1]);return{left:i,right:o,top:a,bottom:s,width:o-i,height:s-a}}}),this.init()}function s(t,e,r,n){for(var i,o,a=0,s=r.length;s>a;a+=2){if(i=t+r[a],o=e+r[a+1],o>=b||O.check(i,o))return!0;if(!n&&0>i||i>=k)return!0}return!1}function h(){return O.clearAll(),A.started=!0,A.animate(),!1}var c={autoplay:!1,showFieldOnStart:!0,theme:$.fn.tetris.themes.retro,blockWidth:10,autoBlockWidth:!1,autoBlockSize:24,difficulty:"normal",onStart:function(){}};"object"!=typeof t&&(t={}),c=$.extend(c,t);var u=$(this);u.html(""),c.autoBlockWidth&&(c.blockWidth=Math.ceil(u.width()/c.autoBlockSize));var f=$('<canvas style="width:100%; height:100%; display:block;" />');u.append(f);var l=$('<div class="tetris-score-holder" style="position:absolute; top:0; right:0; "><div class="tetris-score"><div class="tetris-score-msg">Score</div><div class="tetris-score-num">0</div></div></div>'),d=l.find(".tetris-score-num");u.append(l);var p=$('<div class="tetris-start-holder" style="position:absolute; top:0; left:0; right:0; bottom:0;"><div class="tetris-start"><button class="tetris-start-btn btn">Play Tetris</button></div></div>');u.append(p),p.find(".tetris-start-btn").click(function(t){t.preventDefault(),p.fadeOut(200),v.fadeOut(200),h(),c.onStart()});var v=$('<div class="tetris-game-over-holder" style="position:absolute; top:0; left:0; right:0; bottom:0; display:none;"><div class="tetris-game-over"><div class="tetris-game-over-msg">Game Over</div><button class="tetris-game-over-btn btn">Play Again</button></div></div>');v.find(".tetris-game-over-btn").click(function(t){t.preventDefault(),p.fadeOut(200),v.fadeOut(200),h(),c.onStart()}),u.append(v);var y=function(t,e){function r(t,r,n,i,o,a,s){var h,c,u,f,l=r.length,d=0,p={};for(h=0;l>h;h+=2)d+=t[o.asIndex(n+r[h],i+r[h+1])]||0;for(h=0;l>h;h+=2)c=r[h],u=r[h+1],(p[c]===e||p[c]<u)&&(p[c]=u);f=0;for(c in p)for(c=parseInt(c),u=p[c]+1,h=0;s>i+u;u++,h++)if(!o.check(n+c,i+u)){f+=0==h?2:1;break}return d-=f}function n(){for(var t in o)o[t].x=0,o[t].y=-1}var i,o={};for(i in t)o[i]=t[i]();var a=function(t,i,a,s,h,c){c||n();var u,f,l,d,p,v,y,m,g,k,b,w,x,$,S,C=new Array(a*s),M="evil"==h,B=999*(M?1:-1);for(u=0;a>u;u++)for(f=0;s>=f;f++)if(f==s||t.check(u,f)){for(l=f-4;f>l;l++)C[t.asIndex(u,l)]=l;break}var D=c===e?o:{cur:c};for(d in D){for(p=D[d],x=-999,v=0;v<(p.symmetrical?2:4);v++)for(y=p.getBlocks(v),m=p.getBounds(y),u=-m.left;u<a-m.width;u++)for(f=-1;f<s-m.bottom;f++)if(i(u,f+1,y,!0)){g=r(C,y,u,f,t,a,s),g>x&&(x=g,$=v,S=u);break}(M&&B>x||!M&&x>B)&&(k=p,B=x,b=$,w=S)}return k.best_orientation=b,k.best_x=w,k};return a.no_preview=!0,a},m=f.get(0),g=m.getContext("2d"),k=c.blockWidth,b=Math.floor(u.innerHeight()/u.innerWidth()*k),w=u.innerWidth(),x=u.innerHeight(),S=Math.floor(w/k),C=Math.floor(S/10),M=2,B=!1;e(),$(window).resize(function(){e()});var D={line:function(){var t=[0,-1,0,-2,0,-3,0,-4],e=[-1,-2,0,-2,1,-2,2,-2];return new a([t,e,t,e],o("line"),!0,"line")},square:function(){var t=[0,0,1,0,0,-1,1,-1];return new a([t,t,t,t],o("square"),!0,"square")},arrow:function(){return new a([[0,-1,1,-1,2,-1,1,-2],[1,-2,1,-1,1,0,2,-1],[0,-1,1,-1,2,-1,1,0],[0,-1,1,-1,1,-2,1,0]],o("arrow"),!1,"arrow")},rightHook:function(){return new a([[0,0,0,-1,1,-1,2,-1],[0,-2,1,0,1,-1,1,-2],[0,-1,1,-1,2,-1,2,-2],[0,-2,0,-1,0,0,1,0]],o("rightHook"),!1,"rightHook")},leftHook:function(){return new a([[2,0,0,-1,1,-1,2,-1],[0,0,1,0,1,-1,1,-2],[0,-2,0,-1,1,-1,2,-1],[0,0,0,-1,0,-2,1,-2]],o("leftHook"),!1,"leftHook")},leftZag:function(){var t=[0,0,0,-1,1,-1,1,-2],e=[0,-1,1,-1,1,0,2,0];return new a([e,t,e,t],o("leftZag"),!0,"leftZag")},rightZag:function(){var t=[0,-2,0,-1,1,-1,1,0],e=[0,0,1,0,1,-1,2,-1];return new a([e,t,e,t],o("rightZag"),!0,"rightZag")}},H=[];$.each(D,function(t,e){H.push(e)});var O={data:new Array(k*b),score:0,toClear:{},check:function(t,e){return this.data[this.asIndex(t,e)]},add:function(t,e,r){t>=0&&k>t&&e>=0&&b>e&&(this.data[this.asIndex(t,e)]=r)},asIndex:function(t,e){return t+e*k},asX:function(t){return t%k},asY:function(t){return Math.floor(t/k)},clearAll:function(){this.data=new Array(k*b)},_popRow:function(t){for(var e=k*(t+1)-1;e>=0;e--)this.data[e]=e>=k?this.data[e-k]:void 0},checkForClears:function(){var t,e,r,n,i=A.lines,o=[];for(t=0,e=this.data.length;e>t;t++)n=this.asX(t),0==n&&(r=0),this.data[t]&&"string"==typeof this.data[t]&&(r+=1),n==k-1&&r==k&&o.push(this.asY(t));for(t=0,e=o.length;e>t;t++)this._popRow(o[t]),A.lines++,A.lines%10==0&&A.dropDelay>1&&(A.dropDelay-=2);var a=A.lines-i;this._updateScore(a)},_updateScore:function(t){if(!(0>=t)){var e=[0,400,1e3,3e3,12e3];t>=e.length&&(t=e.length-1),this.score+=e[t],d.text(this.score)}},draw:function(){for(var t,e,r=0,n=this.data.length;n>r;r++)void 0!==this.data[r]&&(t=this.asY(r),e=this.data[r],i(this.asX(r),t,e))}},_=y(D),A={animateDelay:10,cur:null,lines:0,dropCount:0,dropDelay:24,init:function(){this.cur=this.nextShape();var t,e,a,s,h,u=[],f=[];for(var t in D)f.push(o(t,!1));for(t=0,e=k;e>t;t++)for(a=0,s=n([r(0,8),r(5,9)]);s>a;a++)h&&r(0,3)||(h=n(f)),u.push([t,b-a,h]);if(c.showFieldOnStart)for(t=0,e=u.length;e>t;t++)i.apply(i,u[t]);this.showStartMessage()},showStartMessage:function(){p.show()},showGameOverMessage:function(){v.show()},nextShape:function(t){var e,r,i,o=this.next;if(e=D[W.mode]?D[W.mode]:"nice"==W.mode||"evil"==W.mode?_:n(H),e.no_preview){if(this.next=null,t)return null;if(r=e(O,s,k,b,W.mode),!r)throw new Error("No shape returned from shape function!",e);r.init(),i=r}else{if(r=e(O,s,k,b,W.mode),!r)throw new Error("No shape returned from shape function!",e);if(r.init(),this.next=r,t)return null;i=o||this.nextShape()}return B&&(_(O,s,k,b,"normal",i),i.orientation=i.best_orientation,i.x=i.best_x),i},animate:function(){var t=!1,r=!1;if(e(),!this.paused){if(this.dropCount++,(this.dropCount>=this.dropDelay||B)&&(t=!0,this.dropCount=0),t){var n=this.cur,i=n.x,a=n.y,c=n.getBlocks();if(s(i,a+1,c,!0)){t=!1;for(var u=0;u<n.blocksLen;u+=2)O.add(i+c[u],a+c[u+1],o(n.blockType,!1)),a+c[u]<0&&(r=!0);O.checkForClears(),this.cur=this.nextShape()}}g.clearRect(0,0,w,x),O.draw(),this.cur.draw(t)}r?B?h():(this.showGameOverMessage(),A.gameOver=!0):window.setTimeout(function(){A.animate()},this.animateDelay)}},W={mode:c.difficulty,modes:["normal","nice","evil"],modesY:170,autopilotY:null,init:function(){this.mode=c.difficulty},setMode:function(t){this.mode=t,A.nextShape(!0)}};W.init(),A.init(),c.autoplay?(B=!0,p.hide(),v.hide(),h()):($(document).keyup(function(t){return A.started||13!=t.keyCode&&32!=t.keyCode?!0:h(t)}),$(document).keyup(function(t){80==t.keyCode&&(A.paused=!A.paused)}),$(document).safekeypress(function(t){var e=!1;if(A.cur)switch(e=!0,t.keyCode){case 37:A.cur.moveLeft();break;case 38:A.cur.rotate(!0);break;case 39:A.cur.moveRight();break;case 40:A.dropCount=A.dropDelay;break;case 88:A.cur.rotate(!0);break;case 90:A.cur.rotate(!1);break;default:e=!1}return e&&t.preventDefault(),!e}))})};